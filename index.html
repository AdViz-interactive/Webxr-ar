<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebXR AR Model Viewer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #000; overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; }
        #ui { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); padding: 15px; border-radius: 8px; z-index: 100; }
        #modelUrl { padding: 8px; width: 300px; border-radius: 4px; border: 1px solid #ccc; }
        #loadBtn { padding: 8px 16px; margin-left: 8px; background: #00c853; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        #status { position: fixed; bottom: 20px; left: 20px; color: #0f0; font-family: monospace; font-size: 12px; background: rgba(0,0,0,0.85); padding: 10px; border-radius: 4px; max-width: 300px; }
    </style>
</head>
<body>
    <div id="ui">
        <input id="modelUrl" type="text" placeholder="Enter GLB/GLTF model URL" value="https://threejs.org/examples/models/gltf/Duck/glTF/Duck.gltf">
        <button id="loadBtn">Load Model</button>
    </div>
    <div id="status">Loading...</div>

    <script async src="https://ga.jscdn.org/libs/three.js/r128/three.min.js"></script>
    <script async src="https://ga.jscdn.org/libs/three.js/r128/examples/js/loaders/GLTFLoader.js"></script>
    <script async src="https://ga.jscdn.org/libs/three.js/r128/examples/js/webxr/ARButton.js"></script>

    <script>
        let scene, camera, renderer, controller;
        let reticle, currentModel = null;
        let hitTestSource = null, hitTestSourceRequested = false;
        const placedModels = [];

        function updateStatus(msg) {
            document.getElementById('status').textContent = msg;
            console.log(msg);
        }

        function checkThreeLoaded() {
            if (typeof THREE === 'undefined' || !THREE.GLTFLoader || !THREE.ARButton) {
                updateStatus('Loading Three.js...');
                setTimeout(checkThreeLoaded, 100);
            } else {
                initAR();
            }
        }

        function initAR() {
            updateStatus('Initializing AR...');
            
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            document.body.appendChild(renderer.domElement);

            const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
            scene.add(light);

            // Reticle
            const geometry = new THREE.RingGeometry(0.08, 0.1, 32).rotateX(-Math.PI / 2);
            const material = new THREE.MeshBasicMaterial({ color: 0xffffff });
            reticle = new THREE.Mesh(geometry, material);
            reticle.matrixAutoUpdate = false;
            reticle.visible = false;
            scene.add(reticle);

            // Controller
            controller = renderer.xr.getController(0);
            controller.addEventListener('select', placeModel);
            scene.add(controller);

            // AR Button
            const arButton = THREE.ARButton.createButton(renderer, {
                requiredFeatures: ['hit-test'],
                optionalFeatures: ['dom-overlay'],
                domOverlay: { root: document.body }
            });
            document.body.appendChild(arButton);

            window.addEventListener('resize', onWindowResize);
            renderer.setAnimationLoop(render);
            updateStatus('AR Ready - Enter camera mode');
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function loadModel(url) {
            if (!url.trim()) {
                updateStatus('Please enter a URL');
                return;
            }
            updateStatus('Loading model...');
            const loader = new THREE.GLTFLoader();
            loader.load(url,
                (gltf) => {
                    if (currentModel) scene.remove(currentModel);
                    currentModel = gltf.scene;
                    const box = new THREE.Box3().setFromObject(currentModel);
                    const size = box.getSize(new THREE.Vector3()).length();
                    currentModel.scale.setScalar(1 / size);
                    currentModel.position.z = -3;
                    scene.add(currentModel);
                    updateStatus('Model loaded. Press Enter AR to start.');
                },
                (progress) => {
                    const pct = (progress.loaded / progress.total * 100).toFixed(0);
                    updateStatus(`Loading: ${pct}%`);
                },
                (error) => {
                    updateStatus('Error loading model');
                    console.error(error);
                }
            );
        }

        function placeModel() {
            if (!reticle.visible || !currentModel) return;
            const clone = currentModel.clone();
            clone.position.setFromMatrixPosition(reticle.matrix);
            clone.quaternion.setFromRotationMatrix(reticle.matrix);
            scene.add(clone);
            placedModels.push(clone);
            updateStatus(`Model placed (${placedModels.length})`);
        }

        function render(time, frame) {
            if (frame) {
                const session = renderer.xr.getSession();
                const referenceSpace = renderer.xr.getReferenceSpace();

                if (!hitTestSourceRequested && session && referenceSpace) {
                    session.requestReferenceSpace('viewer')
                        .then(space => session.requestHitTestSource({ space }))
                        .then(source => { hitTestSource = source; })
                        .catch(e => console.error(e));
                    session.addEventListener('end', () => {
                        hitTestSourceRequested = false;
                        hitTestSource = null;
                    });
                    hitTestSourceRequested = true;
                }

                if (hitTestSource && frame) {
                    const results = frame.getHitTestResults(hitTestSource);
                    if (results.length > 0) {
                        reticle.visible = true;
                        reticle.matrix.fromArray(results[0].getPose(referenceSpace).transform.matrix);
                    } else {
                        reticle.visible = false;
                    }
                }
            }
            renderer.render(scene, camera);
        }

        document.getElementById('loadBtn').addEventListener('click', () => {
            loadModel(document.getElementById('modelUrl').value);
        });

        document.getElementById('modelUrl').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loadModel(e.target.value);
        });

        // Start checking for Three.js
        updateStatus('Checking Three.js...');
        setTimeout(checkThreeLoaded, 100);
    </script>
</body>
</html>
